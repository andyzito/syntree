<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: singletons/workspace.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: singletons/workspace.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @constructor
 * @classdesc Workspace is in charge of taking user input, sanitizing it, and sending it to the appropriate lower-level control structure.
 */
Syntree.Workspace = function(config_matrix) {
    /**
     * The snap object tied to our svg workspace.
     *
     * @memberof Syntree
     */
    Syntree.snap = Snap("#workspace"); // Ensure that the snap variable exists

    /**
     * The instance of Workspace.
     *
     * @memberof Syntree
     * @see Syntree.Workspace
     */
    Syntree.W = this; // Ensure that workspace is available to objects created from within this constructor

    Syntree.Lib.config(config_matrix, this); // use config matrix to set up some properties

    if (this.tutorial_enabled) {
        $(document).ready(
            function() {
                modal_open('tutorial')
            });
        $(document).on(
            'click',
            '.button_modal__begin-tutorial',
            function() {
                Syntree.Tutorial.start()
            });
        $(document).on(
            'click',
            '.toolbar_button__tutorial',
            function() {
                Syntree.W._eventRewatchTutorial();
            });
    } else {
        $('.toolbar_button__tutorial').remove();
    }

    if (!this.upload_enabled) {
        $('.toolbar_button__upload').remove();
    }
    if (Syntree.Lib.checkType(this.save_tree_script, 'undefined')) {
        $('.toolbar_button__save').remove();
    }
    if (Syntree.Lib.checkType(this.get_trees_script, 'undefined')) {
        $('.toolbar_button__open').remove();
        $('.modal_open').remove();
    }
    if (Syntree.Lib.checkType(this.export_tree_script, 'undefined')) {
        $('.toolbar_button__export').remove();
        $('.modal_export').remove();
    }
    if (this.focus_checking_enabled) {
        $("#workspace_container").prepend('&lt;div class="focus_check_overlay">&lt;/div>');
        $("body").prepend('&lt;div class="focus_check_underlay">&lt;/div>');
        $('.focus_check_underlay').hide();
        this.focused = false;
    }

    this._attachEventListeners();

    // Make the page
    this.page = new Syntree.page_constructor();
    this.page.addTree();
    Syntree.ElementsManager.select(this.page.tree.getRoot());
}

/**
 * Should this constructor accept config properties not listed in its config_map?
 *
 * @type {boolean}
 * @see Syntree.Workspace#config_map
 * @see Syntree.Lib.config
 */
Syntree.Workspace.prototype.accept_unmapped_config = false;

/**
 * An object representing possible arguments to this constructor, what types they need to be, and what default value to use if the passed value is not of the correct type.
 *
 * @type {object}
 * @see Syntree.Workspace#accept_unmapped_config
 * @see Syntree.Lib.config
 */
Syntree.Workspace.prototype.config_map = {
    goal_sentence: {
        type: 'string',
        default_value: '#undefined',
    },
    tutorial_enabled: {
        type: 'boolean',
        default_value: false,
    },
    upload_enabled: {
        type: 'boolean',
        default_value: true,
    },
    save_tree_script: {
        // The path to the script for saving a tree; see this._eventSave below
        // This script should return the tree's id on success, false on failure
        type: 'string',
        default_value: '#undefined',
    },
    get_trees_script: {
        // The path to the script for retrieving saved trees
        // This script should return some HTML on success and false on failure
        type: 'string',
        default_value: '#undefined',
    },
    export_tree_script: {
        // The path to the php script for exporting a tree; see this._eventExport below
        // This script should return a download link for the export file on success, false on failure
        type: 'string',
        default_value: '#undefined',
    },
    focus_checking_enabled: {
        // Should we do focus checking? Set to 'true' if embedded, 'false' for full page
        type: 'boolean',
        default_value: false,
    },
}

/**
 * Attach various event listeners needed for processing user input. This function is a convenience only, used so that the constructor of Workspace is not over burdened.
 */
Syntree.Workspace.prototype._attachEventListeners = function() {
    // Store 'this' as local variable to avoid conflicts in callback scope
    var W = this;

    // This stuff is to fix dragging, which as default triggers on right click
    // We want it to NOT trigger on right click, so we maintain Workspace.rightClick
    // for the drag functions to check
    $(document).on('mousedown', function(e) {
        if (e.which === 3) {
            W.rightClick = true;
        }
    });
    $(document).on('mouseup', function(e) {
        if (e.which === 3) {
            W.rightClick = false;
        }
    });
    window.onblur = function() {
        W.rightClick = false;
    }
    // --------------------------------------------------------------------------
    $(document).on('click', '.arrow, .arrow-shadow', function(e) {W._eventArrowClick(e);});
    $(document).on('click', '.branch, .branch-shadow, .triangle', function(e) {W._eventBranchClick(e);});
    $(document).on('click', '.triangle-button', function(e) {W._eventTriangleButtonClick(e);});
    // Basic events, funneled to event functions below
    $(document).on('click', '.node-label', function(e) {W._eventNodeClick(e);});
    $(document).on('click', '.delete_button', function() {W._eventDel();});
    $(document).on('click', '#page-background', function(e) {W._eventBGClick(e);});
    $(document).on('dblclick', '.node-label', function() {W._eventEnter();});
    $(document).on('input', '.editor', function() {W._eventEditorTyping();});
    // Keyboard stuff
    $(document).on('keydown', function(e) {
        if ((W.focus_checking_enabled &amp;&amp; W.focused) || !W.focus_checking_enabled) {
            if (e.keyCode === 13) { // Enter
                W._eventEnter();
            } else if (e.keyCode === 37) { // Left arrow key
                W._eventLeft(e);
                // return false;
            } else if (e.keyCode === 38) { // Up arrow key
                W._eventUp();
                return false;
            } else if (e.keyCode === 39) { // Right arrow key
                W._eventRight(e);
                // return false;
            } else if (e.keyCode === 40) { // Down arrow key
                W._eventDown(e);
                return false;
            } else if (e.keyCode === 46) { // Delete key
                W._eventDel();
            } else if (e.keyCode === 27) { // Esc key
                W._eventEsc();
            } else if (e.keyCode === 90 &amp;&amp; e.ctrlKey) { // CTRL + Z
                W._eventUndo();
            }
        }
    });
    // Focus checking
    if (W.focus_checking_enabled) {
        $(document).on('click', '.focus_check_overlay', function(){W._eventFocus()});
        $(document).on('click', '.focus_check_underlay', function(){W._eventUnfocus()});
    }
    if (Syntree.Lib.checkType(this.save_tree_script, 'string')) {
        $(document).on('click', '.toolbar_button__save', function(){W._eventSave()});
    }
    // Modal export
    if (Syntree.Lib.checkType(this.export_tree_script, 'string')) {
        $(document).on('click', '.modal_section__filetype .modal_label', function(e) {W._eventFiletypeLabelClick(e)});
        $(document).on('click', '.button_modal__export', function() {
            $(this).addClass('loading');
            var type = $('.modal_section__filetype input:checked').val();
            if (type === 'bracket-file') {
                W._eventExportBrackets();
            } else if (type === 'tree-file') {
                W._eventExportTreeFile();
            } else if (type === 'png') {
                W._eventExportImage();
            }
            $(this).removeClass('loading');
        });
    }
    // Upload
    if (this.upload_enabled) {
        $(document).on('click', '.toolbar_button__upload', function() {
            W._eventUpload();
        });
    }
    // Modal open
    if (Syntree.Lib.checkType(this.get_trees_script, 'string')) {
        $(document).on('click', '.toolbar_button__open', function() {
            $.post(W.get_trees_script, {}, function(result) {
                $('.modal_section__trees').html(result);
            });
        });
    }
}

/**
 * Code to run when a branch's triangle button is clicked.
 *
 * @see Syntree.Branch
 */
Syntree.Workspace.prototype._eventTriangleButtonClick = function(e) {
    var clicked = e.currentTarget;
    var clickedId = $(clicked).attr('id');
    var id = Number(clickedId.substr(clickedId.lastIndexOf('-')+1, clickedId.length));
    Syntree.ElementsManager.allElements[id].triangleToggle();
}

/**
 * Code to run when a branch is clicked.
 *
 * @see Syntree.Branch
 * @see Syntree.ElementsManager.select
 */
Syntree.Workspace.prototype._eventBranchClick = function(e) {
    var clicked = e.currentTarget;
    var clickedId = $(clicked).attr('id');
    var id = Number(clickedId.substr(clickedId.lastIndexOf('-')+1, clickedId.length));
    Syntree.ElementsManager.select(Syntree.ElementsManager.allElements[id]);
}

/**
 * Code to run when an arrow is clicked.
 *
 * @see Syntree.Arrow
 * @see Syntree.ElementsManager.select
 */
Syntree.Workspace.prototype._eventArrowClick = function(e) {
    var clicked = e.currentTarget;
    var clickedId = $(clicked).attr('id');
    var id = Number(clickedId.substr(clickedId.lastIndexOf('-')+1, clickedId.length));
    Syntree.ElementsManager.select(Syntree.ElementsManager.allElements[id]);
}

/**
 * Code to run when a user requests a tutorial restart/rewatch.
 *
 * @see Syntree.Tutorial
 */
Syntree.Workspace.prototype._eventRewatchTutorial = function() {
    var check;
    if (Syntree.Tutorial.running) {
        check = confirm("Restart tutorial?");
    } else {
        check = confirm("This will delete any work you have open. Start tutorial anyway?");
    }
    if (check) {
        Syntree.Page.tree.delete();
        Syntree.Page.addTree();
        Syntree.ElementsManager.select(Syntree.Page.tree.getRoot());
        Syntree.Tutorial.start();
    }
}

/**
 * Code to run when a user attempts to undo an action.
 *
 * @see Syntree.History.undo
 * @see Syntree.Action
 */
Syntree.Workspace.prototype._eventUndo = function() {
    Syntree.History.undo();
}

Syntree.Workspace.prototype._eventUpload = function() {
    var W = this;
    $('body').append('&lt;input type="file" id="temp-choose-file">');
    $('#temp-choose-file').change(function() {
        var f = document.getElementById("temp-choose-file").files[0];
        if (f) {
            var reader = new FileReader();
            reader.readAsText(f, "UTF-8");
            reader.onload = function (e) {
                W.page.openTree(e.target.result);
            }
            reader.onerror = function (e) {
                alert('Unable to read file. Please upload a .tree file.')
            }
        }
        $('#temp-choose-file').remove();
    });
    $('#temp-choose-file').click();
}

Syntree.Workspace.prototype._eventNodeClick = function(e) {
    // clickedNode = Syntree.Lib.checkArg(clickedNode, 'svgtextelement');
    var node = Syntree.ElementsManager.allElements[$(e.currentTarget).attr('id').split('-')[1]];
    if (e.ctrlKey) {
        var a = this.page.createMovementArrow(node);
        if (Syntree.Lib.checkType(a, 'arrow')) {
            Syntree.ElementsManager.select(a);
            return false;
        }
    }
    Syntree.ElementsManager.select(node);
}

Syntree.Workspace.prototype._eventLeft = function(e) {
    if ($(document.activeElement).hasClass('editor') &amp;&amp; $(document.activeElement).val() !== '') {
        return;
    }
    if (Syntree.Lib.checkType(e, 'object') &amp;&amp; !e.ctrlKey) {
        this.page.navigateHorizontal('left');
    } else {
        this.page.navigateHorizontal('left',true);
    }
}

Syntree.Workspace.prototype._eventRight = function(e) {
    if ($(document.activeElement).hasClass('editor') &amp;&amp; $(document.activeElement).val() !== '') {
        return;
    }
    if (Syntree.Lib.checkType(e, 'object') &amp;&amp; !e.ctrlKey) {
        this.page.navigateHorizontal('right');
    } else {
        this.page.navigateHorizontal('right',true);
    }
}

Syntree.Workspace.prototype._eventUp = function() {
    this.page.navigateUp();
}

Syntree.Workspace.prototype._eventDown = function(e) {
    if (Syntree.Lib.checkType(e, 'object') &amp;&amp; Syntree.Lib.checkType(e.ctrlKey, 'boolean') &amp;&amp; e.ctrlKey) {
        this.page.navigateDown(true);
    } else {
        this.page.navigateDown();
    }
}

Syntree.Workspace.prototype._eventDel = function() {
    var selected = Syntree.ElementsManager.getSelected();
    if (Syntree.Lib.checkType(selected, 'node')) {
        if (Syntree.Page.tree.root === selected) {
            var children = Syntree.Page.tree.root.getChildren().slice();
            var c = 0;
            while (c &lt; children.length) {
                var tree = new Syntree.Tree({
                    root: children[c],
                })
                Syntree.ElementsManager.deleteTree(tree);
                c++;
            }
        } else {
            var tree = new Syntree.Tree({
                root: selected,
            })
            Syntree.ElementsManager.deleteTree(tree);
        }
        Syntree.ElementsManager.deselect();
        if (!Syntree.Lib.checkType(Syntree.ElementsManager.getSelected(), 'node')) {
            Syntree.ElementsManager.select(Syntree.Page.tree.getRoot());
        }
    } else {
        selected.delete();
    }
}

Syntree.Workspace.prototype._eventEsc = function() {
    this.page.nodeEditing('cancel');
}

Syntree.Workspace.prototype._eventEditorTyping = function() {
    this.page.nodeEditing('update');
}

Syntree.Workspace.prototype._eventBGClick = function(e) {
    return; //temporary
    var x = e.pageX - $("#workspace").offset().left;
    var y = e.pageY - $("#workspace").offset().top;
    var nearest = this.page.getNearestNode(x,y);
    var newNode = new Syntree.Node(0,0);

    if (Syntree.Lib.checkType(nearest, 'object')) {
        if (nearest.deltaY &lt; -10) {
            if (nearest.deltaX > 0) {
                nearest.node.addChild(newNode,0);
            } else {
                nearest.node.addChild(newNode);
            }
        } else {
            var childIndex = nearest.node.getParent().getChildren().indexOf(nearest.node);
            if (nearest.deltaX > 0) {
                nearest.node.addChild(newNode,childIndex);
            } else {
                nearest.node.addChild(newNode,childIndex+1);
            }
        }
    }
}

Syntree.Workspace.prototype._eventFiletypeLabelClick = function(e) {
    var clicked = $(e.currentTarget).children('input');
    if ($(clicked).val() == 'bracket-file') {
        $('.modal_option__fname span').text('.txt');
    } else if ($(clicked).val() == 'tree-file') {
        $('.modal_option__fname span').text('.tree');
    } else if ($(clicked).val() == 'png') {
        $('.modal_option__fname span').text('.png');
    }
}

Syntree.Workspace.prototype._eventExportImage = function() {
    var path = Syntree.Page.tree._getPath();
    var width = path.rightBound = path.leftBound;
    var height = path.bottomBound - path.topBound;
    var offsetX = (-1*path.leftBound + 25);
    var offsetY = (-1*path.topBound + 25);

    var svgstring = '&lt;svg>'+this.page.getSVGString()+'&lt;/svg>';
    // $('#export-image-canvas').attr('width', (width+100));
    // $('#export-image-canvas').attr('height', (height+50));
    $('#export-image-canvas').attr('width', $('#workspace').width());
    $('#export-image-canvas').attr('height', $('#workspace').height());
    // console.log(svgstring);
    canvg('export-image-canvas', svgstring, {
        ignoreDimensions: false,
        // offsetX: (-1*path.leftBound+25),
        // offsetY: (-1*path.topBound+25),
        // scaleWidth: 5,
        // scaleHeight: 5,
    });
    var canvas = document.getElementById('export-image-canvas');
    var imgd = canvas.toDataURL("image/png");
    var link = '&lt;a id="temp-file-download" href="'+imgd+'" download="mytree.png">&lt;/a>';
    $('body').append(link);
    $(link)[0].click();
}

Syntree.Workspace.prototype._eventExportTreeFile = function() {
    var fname = $('.modal_option__fname input').val();
    var treestring = this.page.tree.getTreeString();
    if (Syntree.Lib.checkType(this.export_tree_script, 'string')) {
        $.post(this.export_tree_script, {fname: fname, type: 'tree-file', treestring: treestring}, function(link){
            $('body').append(link);
            $('#temp-file-download')[0].click();
            $('#temp-file-download').remove();
        })

    }
}

Syntree.Workspace.prototype._eventExportBrackets = function() {
    $('.loading-icon').show();
    // Get fname
    var fname = $('.modal_option__fname input').val();
    // Get brackets
    var brackets = this.page.tree.getBracketNotation();
    // Post it
    if (Syntree.Lib.checkType(this.export_tree_script, 'string')) {
        $.post(this.export_tree_script, {fname: fname, type: 'bracket-file', brackets: brackets}, function(link) {
            $('body').append(link);
            $('#temp-file-download')[0].click();
            $('#temp-file-download').remove();
            $('.loading-icon').hide();
        });
    }
}

Syntree.Workspace.prototype._eventSave = function() {
    var treestring = this.page.tree.getTreeString();
    var W = this;
    if (Syntree.Lib.checkType(this.save_tree_script, 'string')) {
        $.post(this.save_tree_script,{treestring:treestring,treeid:this.page.tree.getId()},function(result){
            if (Number(result)) {
                if (!Syntree.Lib.checkType(Syntree.Page.tree.getId(), 'number')) {
                    W.page.tree.setId(Number(result));
                }
                alert('Saved');
            } else {
                alert('Sorry, there was a problem saving your tree');
            }
        });
    }
}

Syntree.Workspace.prototype._eventFocus = function() {
    $(".focus_check_overlay").hide();
    $(".focus_check_underlay").show();
    window.scrollTo($("#workspace").offset().left,$("#workspace").offset().top);
    // $('body').css('overflow','hidden');
    $('#workspace_container').css('z-index',103);
    this.focused = true;
}

Syntree.Workspace.prototype._eventUnfocus = function() {
    $(".focus_check_overlay").show();
    $(".focus_check_underlay").hide();
    $('body').css('overflow','initial');
    $('#workspace_container').css('z-index',0);
    this.focused = false;
}

Syntree.Workspace.prototype._eventEnter = function() {
    this.page.nodeEditing('toggle');
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Syntree.Action.html">Action</a></li><li><a href="Syntree.Arrow.html">Arrow</a></li><li><a href="Syntree.Branch.html">Branch</a></li><li><a href="Syntree.Element.html">Element</a></li><li><a href="Syntree.Graphic.html">Graphic</a></li><li><a href="Syntree.History.html">History</a></li><li><a href="Syntree.Lib.html">Lib</a></li><li><a href="Syntree.Node.html">Node</a></li><li><a href="Syntree.page_constructor.html">page_constructor</a></li><li><a href="Syntree.SelectableElement.html">SelectableElement</a></li><li><a href="Syntree.Tree.html">Tree</a></li><li><a href="Syntree.Tutorial.html">Tutorial</a></li><li><a href="Syntree.Workspace.html">Workspace</a></li></ul><h3>Namespaces</h3><ul><li><a href="Syntree.html">Syntree</a></li></ul><h3>Global</h3><ul><li><a href="global.html#modal_close">modal_close</a></li><li><a href="global.html#modal_open">modal_open</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Tue Apr 18 2017 16:01:25 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
